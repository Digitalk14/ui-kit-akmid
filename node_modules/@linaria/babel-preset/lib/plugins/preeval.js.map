{"version":3,"file":"preeval.js","names":["isGlobal","id","scope","name","node","hasBinding","hasGlobal","forbiddenGlobals","Set","isBrowserGlobal","has","preeval","babel","options","types","t","pre","file","log","createCustomDebug","getFileIdx","opts","filename","processors","path","traverse","Identifier","p","processTemplateExpression","processor","doEvaltimeReplacement","push","CallExpression","enter","isUnnecessaryReactCall","JSXElementsRemover","JSXElement","JSXFragment","parentPath","isUnaryExpression","operator","isTSTypeQuery","removeWithRelated","visitor","post","length","metadata","linaria","replacements","rules","dependencies","expressions","flatMap","map","dependency","ex","linariaPreval","getData","linariaExport","expressionStatement","assignmentExpression","memberExpression","identifier","objectExpression","objectProperty","pushContainer"],"sources":["../../src/plugins/preeval.ts"],"sourcesContent":["/**\n * This file is a babel preset used to transform files inside evaluators.\n * It works the same as main `babel/extract` preset, but do not evaluate lazy dependencies.\n */\nimport type { BabelFile, NodePath, PluginObj } from '@babel/core';\nimport type { Identifier } from '@babel/types';\n\nimport { createCustomDebug } from '@linaria/logger';\nimport type { StrictOptions } from '@linaria/utils';\nimport {\n  getFileIdx,\n  isUnnecessaryReactCall,\n  JSXElementsRemover,\n  removeWithRelated,\n} from '@linaria/utils';\n\nimport type { Core } from '../babel';\nimport type { IPluginState } from '../types';\nimport processTemplateExpression from '../utils/processTemplateExpression';\n\nexport type PreevalOptions = Pick<\n  StrictOptions,\n  'classNameSlug' | 'displayName' | 'evaluate'\n>;\n\nconst isGlobal = (id: NodePath<Identifier>): boolean => {\n  const { scope } = id;\n  const { name } = id.node;\n  return !scope.hasBinding(name) && scope.hasGlobal(name);\n};\n\nconst forbiddenGlobals = new Set([\n  'XMLHttpRequest',\n  'clearImmediate',\n  'clearInterval',\n  'clearTimeout',\n  'document',\n  'fetch',\n  'localStorage',\n  'location',\n  'navigator',\n  'sessionStorage',\n  'setImmediate',\n  'setInterval',\n  'setTimeout',\n  'window',\n]);\n\nconst isBrowserGlobal = (id: NodePath<Identifier>) => {\n  return forbiddenGlobals.has(id.node.name) && isGlobal(id);\n};\n\nexport default function preeval(\n  babel: Core,\n  options: PreevalOptions\n): PluginObj<IPluginState> {\n  const { types: t } = babel;\n  return {\n    name: '@linaria/babel/preeval',\n    pre(file: BabelFile) {\n      const log = createCustomDebug('preeval', getFileIdx(file.opts.filename!));\n\n      log('start', 'Looking for template literalsâ€¦');\n\n      this.processors = [];\n\n      file.path.traverse({\n        Identifier: (p) => {\n          processTemplateExpression(p, file.opts, options, (processor) => {\n            processor.doEvaltimeReplacement();\n            this.processors.push(processor);\n          });\n        },\n      });\n\n      log('start', 'Strip all JSX and browser related stuff');\n      file.path.traverse({\n        // JSX can be replaced with a dummy value,\n        // but we have to do it after we processed template tags.\n        CallExpression: {\n          enter(p) {\n            if (isUnnecessaryReactCall(p)) {\n              JSXElementsRemover(p);\n            }\n          },\n        },\n        JSXElement: {\n          enter: JSXElementsRemover,\n        },\n        JSXFragment: {\n          enter: JSXElementsRemover,\n        },\n        Identifier(p) {\n          if (isBrowserGlobal(p)) {\n            if (\n              p.parentPath.isUnaryExpression({ operator: 'typeof' }) ||\n              p.parentPath.isTSTypeQuery()\n            ) {\n              // Ignore `typeof window` expressions\n              return;\n            }\n\n            removeWithRelated([p]);\n          }\n        },\n      });\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      const log = createCustomDebug('preeval', getFileIdx(file.opts.filename!));\n\n      if (this.processors.length === 0) {\n        log('end', \"We didn't find any Linaria template literals\");\n\n        // We didn't find any Linaria template literals.\n        return;\n      }\n\n      this.file.metadata.linaria = {\n        processors: this.processors,\n        replacements: [],\n        rules: {},\n        dependencies: [],\n      };\n\n      const expressions: Identifier[] = this.processors.flatMap((processor) =>\n        processor.dependencies.map((dependency) => dependency.ex)\n      );\n\n      const linariaPreval = file.path.scope.getData('__linariaPreval');\n      if (!linariaPreval) {\n        const linariaExport = t.expressionStatement(\n          t.assignmentExpression(\n            '=',\n            t.memberExpression(\n              t.identifier('exports'),\n              t.identifier('__linariaPreval')\n            ),\n            t.objectExpression(\n              expressions.map((ex) => t.objectProperty(ex, ex, false, true))\n            )\n          )\n        );\n\n        file.path.pushContainer('body', linariaExport);\n      }\n\n      log('end', '__linariaPreval has been added');\n    },\n  };\n}\n"],"mappings":";;;;;;;AAOA;;AAEA;;AASA;;;;AAlBA;AACA;AACA;AACA;AAsBA,MAAMA,QAAQ,GAAIC,EAAD,IAAuC;EACtD,MAAM;IAAEC;EAAF,IAAYD,EAAlB;EACA,MAAM;IAAEE;EAAF,IAAWF,EAAE,CAACG,IAApB;EACA,OAAO,CAACF,KAAK,CAACG,UAAN,CAAiBF,IAAjB,CAAD,IAA2BD,KAAK,CAACI,SAAN,CAAgBH,IAAhB,CAAlC;AACD,CAJD;;AAMA,MAAMI,gBAAgB,GAAG,IAAIC,GAAJ,CAAQ,CAC/B,gBAD+B,EAE/B,gBAF+B,EAG/B,eAH+B,EAI/B,cAJ+B,EAK/B,UAL+B,EAM/B,OAN+B,EAO/B,cAP+B,EAQ/B,UAR+B,EAS/B,WAT+B,EAU/B,gBAV+B,EAW/B,cAX+B,EAY/B,aAZ+B,EAa/B,YAb+B,EAc/B,QAd+B,CAAR,CAAzB;;AAiBA,MAAMC,eAAe,GAAIR,EAAD,IAA8B;EACpD,OAAOM,gBAAgB,CAACG,GAAjB,CAAqBT,EAAE,CAACG,IAAH,CAAQD,IAA7B,KAAsCH,QAAQ,CAACC,EAAD,CAArD;AACD,CAFD;;AAIe,SAASU,OAAT,CACbC,KADa,EAEbC,OAFa,EAGY;EACzB,MAAM;IAAEC,KAAK,EAAEC;EAAT,IAAeH,KAArB;EACA,OAAO;IACLT,IAAI,EAAE,wBADD;;IAELa,GAAG,CAACC,IAAD,EAAkB;MACnB,MAAMC,GAAG,GAAG,IAAAC,yBAAA,EAAkB,SAAlB,EAA6B,IAAAC,iBAAA,EAAWH,IAAI,CAACI,IAAL,CAAUC,QAArB,CAA7B,CAAZ;MAEAJ,GAAG,CAAC,OAAD,EAAU,gCAAV,CAAH;MAEA,KAAKK,UAAL,GAAkB,EAAlB;MAEAN,IAAI,CAACO,IAAL,CAAUC,QAAV,CAAmB;QACjBC,UAAU,EAAGC,CAAD,IAAO;UACjB,IAAAC,kCAAA,EAA0BD,CAA1B,EAA6BV,IAAI,CAACI,IAAlC,EAAwCR,OAAxC,EAAkDgB,SAAD,IAAe;YAC9DA,SAAS,CAACC,qBAAV;YACA,KAAKP,UAAL,CAAgBQ,IAAhB,CAAqBF,SAArB;UACD,CAHD;QAID;MANgB,CAAnB;MASAX,GAAG,CAAC,OAAD,EAAU,yCAAV,CAAH;MACAD,IAAI,CAACO,IAAL,CAAUC,QAAV,CAAmB;QACjB;QACA;QACAO,cAAc,EAAE;UACdC,KAAK,CAACN,CAAD,EAAI;YACP,IAAI,IAAAO,6BAAA,EAAuBP,CAAvB,CAAJ,EAA+B;cAC7B,IAAAQ,yBAAA,EAAmBR,CAAnB;YACD;UACF;;QALa,CAHC;QAUjBS,UAAU,EAAE;UACVH,KAAK,EAAEE;QADG,CAVK;QAajBE,WAAW,EAAE;UACXJ,KAAK,EAAEE;QADI,CAbI;;QAgBjBT,UAAU,CAACC,CAAD,EAAI;UACZ,IAAIlB,eAAe,CAACkB,CAAD,CAAnB,EAAwB;YACtB,IACEA,CAAC,CAACW,UAAF,CAAaC,iBAAb,CAA+B;cAAEC,QAAQ,EAAE;YAAZ,CAA/B,KACAb,CAAC,CAACW,UAAF,CAAaG,aAAb,EAFF,EAGE;cACA;cACA;YACD;;YAED,IAAAC,wBAAA,EAAkB,CAACf,CAAD,CAAlB;UACD;QACF;;MA5BgB,CAAnB;IA8BD,CAjDI;;IAkDLgB,OAAO,EAAE,EAlDJ;;IAmDLC,IAAI,CAAC3B,IAAD,EAAkB;MACpB,MAAMC,GAAG,GAAG,IAAAC,yBAAA,EAAkB,SAAlB,EAA6B,IAAAC,iBAAA,EAAWH,IAAI,CAACI,IAAL,CAAUC,QAArB,CAA7B,CAAZ;;MAEA,IAAI,KAAKC,UAAL,CAAgBsB,MAAhB,KAA2B,CAA/B,EAAkC;QAChC3B,GAAG,CAAC,KAAD,EAAQ,8CAAR,CAAH,CADgC,CAGhC;;QACA;MACD;;MAED,KAAKD,IAAL,CAAU6B,QAAV,CAAmBC,OAAnB,GAA6B;QAC3BxB,UAAU,EAAE,KAAKA,UADU;QAE3ByB,YAAY,EAAE,EAFa;QAG3BC,KAAK,EAAE,EAHoB;QAI3BC,YAAY,EAAE;MAJa,CAA7B;MAOA,MAAMC,WAAyB,GAAG,KAAK5B,UAAL,CAAgB6B,OAAhB,CAAyBvB,SAAD,IACxDA,SAAS,CAACqB,YAAV,CAAuBG,GAAvB,CAA4BC,UAAD,IAAgBA,UAAU,CAACC,EAAtD,CADgC,CAAlC;MAIA,MAAMC,aAAa,GAAGvC,IAAI,CAACO,IAAL,CAAUtB,KAAV,CAAgBuD,OAAhB,CAAwB,iBAAxB,CAAtB;;MACA,IAAI,CAACD,aAAL,EAAoB;QAClB,MAAME,aAAa,GAAG3C,CAAC,CAAC4C,mBAAF,CACpB5C,CAAC,CAAC6C,oBAAF,CACE,GADF,EAEE7C,CAAC,CAAC8C,gBAAF,CACE9C,CAAC,CAAC+C,UAAF,CAAa,SAAb,CADF,EAEE/C,CAAC,CAAC+C,UAAF,CAAa,iBAAb,CAFF,CAFF,EAME/C,CAAC,CAACgD,gBAAF,CACEZ,WAAW,CAACE,GAAZ,CAAiBE,EAAD,IAAQxC,CAAC,CAACiD,cAAF,CAAiBT,EAAjB,EAAqBA,EAArB,EAAyB,KAAzB,EAAgC,IAAhC,CAAxB,CADF,CANF,CADoB,CAAtB;QAaAtC,IAAI,CAACO,IAAL,CAAUyC,aAAV,CAAwB,MAAxB,EAAgCP,aAAhC;MACD;;MAEDxC,GAAG,CAAC,KAAD,EAAQ,gCAAR,CAAH;IACD;;EA3FI,CAAP;AA6FD"}