{"version":3,"file":"index.js","names":["path","createFilter","transform","slugify","createCustomDebug","getFileIdx","linaria","include","exclude","sourceMap","preprocessor","rest","filter","cssLookup","config","codeCache","Map","resolveCache","evalCache","name","configResolved","resolvedConfig","load","id","resolveId","importee","code","log","asyncResolve","what","importer","resolved","resolve","split","Error","result","filename","pluginOptions","cssText","slug","replace","cssSourceMapText","map","Buffer","from","toString","command","root","posix","relative","JSON","stringify"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Rollup loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport { createFilter } from '@rollup/pluginutils';\nimport type { Plugin } from 'rollup';\n\nimport { transform, slugify } from '@linaria/babel-preset';\nimport type {\n  PluginOptions,\n  Preprocessor,\n  Result,\n  CodeCache,\n  Module,\n} from '@linaria/babel-preset';\nimport { createCustomDebug } from '@linaria/logger';\nimport { getFileIdx } from '@linaria/utils';\n\ntype RollupPluginOptions = {\n  include?: string | string[];\n  exclude?: string | string[];\n  sourceMap?: boolean;\n  preprocessor?: Preprocessor;\n} & Partial<PluginOptions>;\n\ntype ViteConfig = {\n  root: string;\n  command: 'serve' | 'build';\n};\n\nexport default function linaria({\n  include,\n  exclude,\n  sourceMap,\n  preprocessor,\n  ...rest\n}: RollupPluginOptions = {}): Plugin & {\n  configResolved: (config: ViteConfig) => void;\n} {\n  const filter = createFilter(include, exclude);\n  const cssLookup: { [key: string]: string } = {};\n  let config: ViteConfig;\n\n  const codeCache: CodeCache = new Map();\n  const resolveCache = new Map<string, string>();\n  const evalCache = new Map<string, Module>();\n\n  return {\n    name: 'linaria',\n    configResolved(resolvedConfig: ViteConfig) {\n      config = resolvedConfig;\n    },\n    load(id: string) {\n      return cssLookup[id];\n    },\n    /* eslint-disable-next-line consistent-return */\n    resolveId(importee: string) {\n      if (importee in cssLookup) return importee;\n    },\n    async transform(\n      code: string,\n      id: string\n    ): Promise<{ code: string; map: Result['sourceMap'] } | undefined> {\n      // Do not transform ignored and generated files\n      if (!filter(id) || id in cssLookup) return;\n\n      const log = createCustomDebug('rollup', getFileIdx(id));\n\n      log('rollup-init', id);\n\n      const asyncResolve = async (what: string, importer: string) => {\n        const resolved = await this.resolve(what, importer);\n        if (resolved) {\n          log('resolve', \"✅ '%s'@'%s -> %O\\n%s\", what, importer, resolved);\n          // Vite adds param like `?v=667939b3` to cached modules\n          return resolved.id.split('?')[0];\n        }\n\n        log('resolve', \"❌ '%s'@'%s\", what, importer);\n        throw new Error(`Could not resolve ${what}`);\n      };\n\n      const result = await transform(\n        code,\n        {\n          filename: id,\n          preprocessor,\n          pluginOptions: rest,\n        },\n        asyncResolve,\n        {},\n        resolveCache,\n        codeCache,\n        evalCache\n      );\n\n      if (!result.cssText) return;\n\n      let { cssText } = result;\n\n      const slug = slugify(cssText);\n      const filename = `${id.replace(/\\.[jt]sx?$/, '')}_${slug}.css`;\n\n      if (sourceMap && result.cssSourceMapText) {\n        const map = Buffer.from(result.cssSourceMapText).toString('base64');\n        cssText += `/*# sourceMappingURL=data:application/json;base64,${map}*/`;\n      }\n\n      cssLookup[filename] = cssText;\n      if (config?.command === 'serve' && config?.root) {\n        cssLookup[`/${path.posix.relative(config.root, filename)}`] = cssText;\n      }\n\n      result.code += `\\nimport ${JSON.stringify(filename)};\\n`;\n\n      /* eslint-disable-next-line consistent-return */\n      return { code: result.code, map: result.sourceMap };\n    },\n  };\n}\n"],"mappings":"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"}