{"version":3,"file":"index.js","names":["configCache","Map","getShakerConfig","only","sortedOnly","sort","key","join","has","get","config","ast","caller","name","targets","node","esmodules","plugins","require","resolve","onlyExports","set","shaker","filename","options","text","babel","transformOptions","loadBabelOptions","buildOptions","babelOptions","transformed","transformSync","hasShakerMetadata","metadata","Error","code","__linariaShaker","imports"],"sources":["../src/index.ts"],"sourcesContent":["import type { TransformOptions } from '@babel/core';\nimport { transformSync } from '@babel/core';\n\nimport { buildOptions, loadBabelOptions } from '@linaria/utils';\nimport type { Evaluator } from '@linaria/utils';\n\nimport { hasShakerMetadata } from './plugins/shaker-plugin';\n\nexport { default as shakerPlugin } from './plugins/shaker-plugin';\n\nconst configCache = new Map<string, TransformOptions>();\nconst getShakerConfig = (only: string[] | null): TransformOptions => {\n  const sortedOnly = [...(only ?? [])];\n  sortedOnly.sort();\n  const key = sortedOnly.join('\\0');\n  if (configCache.has(key)) {\n    return configCache.get(key)!;\n  }\n\n  const config = {\n    ast: true,\n    caller: {\n      name: 'linaria',\n    },\n    targets: {\n      node: 'current',\n      esmodules: false,\n    },\n    plugins: [\n      [\n        require.resolve('./plugins/shaker-plugin'),\n        {\n          onlyExports: sortedOnly,\n        },\n      ],\n      require.resolve('@babel/plugin-transform-modules-commonjs'),\n    ],\n  };\n\n  configCache.set(key, config);\n  return config;\n};\n\nconst shaker: Evaluator = (filename, options, text, only, babel) => {\n  const transformOptions = loadBabelOptions(\n    babel,\n    filename,\n    buildOptions(options?.babelOptions, getShakerConfig(only))\n  );\n\n  const transformed = transformSync(text, {\n    ...transformOptions,\n    filename,\n  });\n\n  if (!transformed || !hasShakerMetadata(transformed.metadata)) {\n    throw new Error(`${filename} has no shaker metadata`);\n  }\n\n  return [transformed.code ?? '', transformed.metadata.__linariaShaker.imports];\n};\n\nexport default shaker;\n"],"mappings":";;;;;;;;;;;;;AACA;;AAEA;;AAGA;;;;;;AAIA,MAAMA,WAAW,GAAG,IAAIC,GAAJ,EAApB;;AACA,MAAMC,eAAe,GAAIC,IAAD,IAA6C;EACnE,MAAMC,UAAU,GAAG,CAAC,IAAID,IAAJ,aAAIA,IAAJ,cAAIA,IAAJ,GAAY,EAAZ,CAAD,CAAnB;EACAC,UAAU,CAACC,IAAX;EACA,MAAMC,GAAG,GAAGF,UAAU,CAACG,IAAX,CAAgB,IAAhB,CAAZ;;EACA,IAAIP,WAAW,CAACQ,GAAZ,CAAgBF,GAAhB,CAAJ,EAA0B;IACxB,OAAON,WAAW,CAACS,GAAZ,CAAgBH,GAAhB,CAAP;EACD;;EAED,MAAMI,MAAM,GAAG;IACbC,GAAG,EAAE,IADQ;IAEbC,MAAM,EAAE;MACNC,IAAI,EAAE;IADA,CAFK;IAKbC,OAAO,EAAE;MACPC,IAAI,EAAE,SADC;MAEPC,SAAS,EAAE;IAFJ,CALI;IASbC,OAAO,EAAE,CACP,CACEC,OAAO,CAACC,OAAR,CAAgB,yBAAhB,CADF,EAEE;MACEC,WAAW,EAAEhB;IADf,CAFF,CADO,EAOPc,OAAO,CAACC,OAAR,CAAgB,0CAAhB,CAPO;EATI,CAAf;EAoBAnB,WAAW,CAACqB,GAAZ,CAAgBf,GAAhB,EAAqBI,MAArB;EACA,OAAOA,MAAP;AACD,CA9BD;;AAgCA,MAAMY,MAAiB,GAAG,CAACC,QAAD,EAAWC,OAAX,EAAoBC,IAApB,EAA0BtB,IAA1B,EAAgCuB,KAAhC,KAA0C;EAAA;;EAClE,MAAMC,gBAAgB,GAAG,IAAAC,uBAAA,EACvBF,KADuB,EAEvBH,QAFuB,EAGvB,IAAAM,mBAAA,EAAaL,OAAb,aAAaA,OAAb,uBAAaA,OAAO,CAAEM,YAAtB,EAAoC5B,eAAe,CAACC,IAAD,CAAnD,CAHuB,CAAzB;EAMA,MAAM4B,WAAW,GAAG,IAAAC,mBAAA,EAAcP,IAAd,EAAoB,EACtC,GAAGE,gBADmC;IAEtCJ;EAFsC,CAApB,CAApB;;EAKA,IAAI,CAACQ,WAAD,IAAgB,CAAC,IAAAE,+BAAA,EAAkBF,WAAW,CAACG,QAA9B,CAArB,EAA8D;IAC5D,MAAM,IAAIC,KAAJ,CAAW,GAAEZ,QAAS,yBAAtB,CAAN;EACD;;EAED,OAAO,sBAACQ,WAAW,CAACK,IAAb,iEAAqB,EAArB,EAAyBL,WAAW,CAACG,QAAZ,CAAqBG,eAArB,CAAqCC,OAA9D,CAAP;AACD,CAjBD;;eAmBehB,M"}